<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Xuchen Ma&#39;s Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Xuchen Ma&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Xuchen Ma's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Xuchen Ma's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/06/autotuner/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xuchen Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/06/autotuner/" class="post-title-link" itemprop="url">Autotuner</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-05-06 10:22:14" itemprop="dateCreated datePublished" datetime="2023-05-06T10:22:14+08:00">2023-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 15:40:10" itemprop="dateModified" datetime="2023-05-07T15:40:10+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Autotuner整体结构"><a href="#1-Autotuner整体结构" class="headerlink" title="1. Autotuner整体结构"></a>1. Autotuner整体结构</h1><p>一开始尝试了<a target="_blank" rel="noopener" href="https://github.com/jansel/opentuner">OpenTuner</a>的使用，安装后也成功运行了示例。在了解project1的需求后，决定尝试自己实现一个Autotuner测试MatrixMultiplication.c程序的可配置参数，根据性能选择最优配置输出。</p>
<p>使用Python进行项目搭建。</p>
<h2 id="1-文件树"><a href="#1-文件树" class="headerlink" title="(1) 文件树"></a>(1) 文件树</h2><p>所有项目代码结构如下: </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">│  Autotuner.py----------------------Autotuner主程序</span><br><span class="line">│  input.txt-------------------------所有输入信息(目标程序、参数组合、参数搜索算法)</span><br><span class="line">│  MatrixMultiplication.c------------被测试程序</span><br><span class="line">│  test.py---------------------------执行测试程序，调用Autotuner接口</span><br><span class="line">│  testCounter.txt-------------------记录test的次数，每次测试创建新的测试结果文件夹</span><br><span class="line">│</span><br><span class="line">├─codes------------------------------代码文件夹</span><br><span class="line">│  ├─input-----------------------------输入模块</span><br><span class="line">│  │      InputDealer.py-----------------处理用户的三种输入</span><br><span class="line">│  │</span><br><span class="line">│  ├─runners---------------------------执行模块</span><br><span class="line">│  │  └─C_runner-------------------------C语言程序执行模块</span><br><span class="line">│  │         C_runner.py-------------------C语言程序执行程序</span><br><span class="line">│  │</span><br><span class="line">│  └─search_algs-----------------------参数搜索模块</span><br><span class="line">│          allAlgs.py--------------------综合处理所有搜索算法</span><br><span class="line">│          GreedySearch.py---------------贪心搜索算法程序</span><br><span class="line">│          GridSearch.py-----------------网格搜索算法程序</span><br><span class="line">│</span><br><span class="line">├─result-----------------------------测试结果文件夹</span><br><span class="line">  ├─test1------------------------------测试结果1</span><br><span class="line">  │  │  program.c------------------------复制过来的被测程序</span><br><span class="line">  │  │  result.txt-----------------------测试结果</span><br><span class="line">  │  │</span><br><span class="line">  │  └─tmp-----------------------------编译产生的临时文件夹</span><br><span class="line">  │          out.txt---------------------获取被测文件的输出，写入其中</span><br><span class="line">  │          tmp.exe---------------------编译生成的可执行文件</span><br><span class="line">  │</span><br><span class="line">  └─test2</span><br><span class="line">      │  program.c</span><br><span class="line">      │  result.txt</span><br><span class="line">      │</span><br><span class="line">      └─tmp</span><br><span class="line">              out.txt</span><br><span class="line">              tmp.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-项目结构"><a href="#2-项目结构" class="headerlink" title="(2) 项目结构"></a>(2) 项目结构</h2><p>整个测试过程的流程图如下所示： </p>
<p><img src="/2023/05/06/autotuner/image-20221025150956475.png" alt="image-20221025150956475"></p>
<p>详细流程： </p>
<ol>
<li><p>test.py调用Autotuner.py的相关接口，执行Autotuner.test()方法开始测试。</p>
</li>
<li><p>Autotuner首先调用InputDealer处理用户的输入。</p>
</li>
<li><p>然后根据被测程序的后缀名选择合适的Runner(.c用C_runner, .py用Py_runner, .java用Java_runner等)。</p>
</li>
<li><p>再根据选择的搜索算法，调用对应的Searcher。</p>
</li>
<li><p>Searcher内部调用Runner，提供参数的同时获得Runner的反馈，执行其参数搜索算法。</p>
</li>
<li><p>最后Searcher给出最优性能的参数组合。</p>
</li>
</ol>
<h2 id="3-InputDealer"><a href="#3-InputDealer" class="headerlink" title="(3) InputDealer"></a>(3) InputDealer</h2><p>整个InputDealer获取参数的详细过程如下： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">----------------------------Autotuner----------------------------</span><br><span class="line">Input the program, parameters combination and searching algorithm, </span><br><span class="line">then test the program to search the best combination of parameters.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Absolute address of program:</span><br><span class="line">E:\_files\MajorLessons\软件系统优化\project\p1\project\</span><br><span class="line">MatrixMultiplication.c</span><br><span class="line"></span><br><span class="line">Please input the compiling parameters:</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">        `Type &#x27;\example&#x27; to view an example</span><br><span class="line">        `Type &#x27;\end&#x27; to end input</span><br><span class="line">param1 name :optimize_level</span><br><span class="line">values :O0,O1,O2,O3</span><br><span class="line">param2 name :\end</span><br><span class="line"></span><br><span class="line">Please input the running parameters:</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">        `Type &#x27;\example&#x27; to view an example</span><br><span class="line">        `Type &#x27;\end&#x27; to end input</span><br><span class="line">param1 name :block_size</span><br><span class="line">values :8,16,32,64,128</span><br><span class="line">param2 name :\end</span><br><span class="line"></span><br><span class="line">Supported algorithms:</span><br><span class="line">        1. Grid Search</span><br><span class="line">        2. Greedy Search</span><br><span class="line">Input the number of algorithm to choose it:</span><br><span class="line">1</span><br><span class="line">Algorithm: Grid Search has been chosed.</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 8&#125;</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先后采集四种参数： </p>
<ul>
<li>被测程序的绝对路径</li>
<li>编译参数空间</li>
<li>运行参数空间</li>
<li>参数搜索算法</li>
</ul>
<p>能够处理多个编译参数和运行参数。</p>
<p>为方便起见，在test.py中将stdin重定向为input.txt。</p>
<p>input.txt:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">E:\_files\MajorLessons\软件系统优化\project\p1\project\MatrixMultiplication.c</span><br><span class="line">optimize_level</span><br><span class="line">O0,O1,O2,O3</span><br><span class="line">\end</span><br><span class="line">block_size</span><br><span class="line">8,16,32,64,128</span><br><span class="line">\end</span><br><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>得到参数后，将其返回给Autotuner对象。</p>
<h2 id="4-Searcher"><a href="#4-Searcher" class="headerlink" title="(4) Searcher"></a>(4) Searcher</h2><p>用编译参数、运行参数、runner以及测试次数iters初始化Searcher。每个Searcher必须有一个search方法，作为Autotuner搜索参数组合的接口。然后所有Searcher的信息保存在allAlgs.py中，维护一个Searcher Map:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .GridSearch <span class="keyword">import</span> GridSearch</span><br><span class="line"><span class="keyword">from</span> .GreedySearch <span class="keyword">import</span> GreedySearch</span><br><span class="line"></span><br><span class="line">ALGS_LIST = [</span><br><span class="line">    <span class="string">&#x27;Grid Search&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Greedy Search&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">algs_dict = &#123;</span><br><span class="line">    ALGS_LIST[<span class="number">0</span>]: GridSearch,</span><br><span class="line">    ALGS_LIST[<span class="number">1</span>]: GreedySearch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Searcher.search()方法产生参数组合: 编译参数组合和运行参数组合，传给runnner运行，并从runnner获得反馈。</p>
<h2 id="5-Runner"><a href="#5-Runner" class="headerlink" title="(5) Runner"></a>(5) Runner</h2><p>不同的Runner用以运行不同语言的程序，Runner有一个.run()方法，获取编译参数和运行参数(若该程序没有编译阶段，则编译参数为None)。</p>
<h1 id="2-实现的优劣"><a href="#2-实现的优劣" class="headerlink" title="2. 实现的优劣"></a>2. 实现的优劣</h1><h2 id="1-优势"><a href="#1-优势" class="headerlink" title="(1) 优势"></a>(1) 优势</h2><ul>
<li>各个模块间耦合度低，模块与模块之间的交流基本只涉及一个接口，其余工作都在模块内部实现，这样使得代码可读性和可延展性很强。</li>
<li>结构的可扩展性很强。若要增加被测程序的类型，添加一个Runner即可；若要添加搜索算法，添加一个Searcher并加入map即可。</li>
<li>能满足多参数搜索。在InputDealer处也可看出，输入的参数可以不止一种，编译参数可以是多种，运行参数也可以是多种。</li>
<li>多次测试会生成不同的文件夹(参考了specjvm2008的result形式)，每次测试在单独的文件夹中进行，互不干扰。</li>
</ul>
<h2 id="2-劣势"><a href="#2-劣势" class="headerlink" title="(2) 劣势"></a>(2) 劣势</h2><ul>
<li>未使用多线程运行测试，可能会导致效率低下。opentuner是采用多线程进行测试的。</li>
<li>用户接口可能过于冗杂。但是考虑到需要输入目标程序，不得不使用这种形式。opentuner是将待测程序直接放在代码中。</li>
</ul>
<h1 id="3-Greedy-Search"><a href="#3-Greedy-Search" class="headerlink" title="3. Greedy Search"></a>3. Greedy Search</h1><p>我自行设计了一种参数搜索算法，命名为“贪心搜索算法”，但在一定程度上，我更愿意叫他梯度下降搜索算法。下面展示其思想。</p>
<p>**Greedy Search执行的流程： **</p>
<ol>
<li><p>随机选取一种参数组合，并测试，得到测试时间。</p>
</li>
<li><p>访问该参数组合的邻域，并对领域的每种组合进行测试。</p>
</li>
<li><p>在邻域的所有测试结果中选择一个时间最短的，然后将当前参数组合改为该参数组合。</p>
</li>
<li><p>重复2,3步，直到当前参数组合耗时为其邻域内耗时最短的，退出，并认为当前参数组合为最优参数组合。</p>
</li>
</ol>
<p>名词解释： </p>
<p>**邻域： ** 保持其他参数不变，只前后改变一种参数，并只在左右1格的范围内改变。如：当前参数组合为{optimize level: O2, block size: 16}，则其邻域为： </p>
<ul>
<li>optimize level: O1, block size: 16</li>
<li>optimize level: O3, block size: 16</li>
<li>optimize level: O2, block size: 8</li>
<li>optimize level: O2, block size: 32</li>
</ul>
<p>当然，在搜索的过程中，会检查该邻域是否访问过了。若已经访问过，则会跳过。因为当前选择的参数组合不是邻域参数组合，说明当前参数组合的运行时间要比邻域的短，所以甚至不用访问该邻域的运行时间，直接跳过即可。</p>
<p>用图像来解释即为：  </p>
<p><img src="/2023/05/06/autotuner/image-20221025160525397.png" alt="image-20221025160525397"></p>
<p><img src="/2023/05/06/autotuner/image-20221025160553142.png" alt="image-20221025160553142"></p>
<p><img src="/2023/05/06/autotuner/image-20221025160601252.png" alt="image-20221025160601252"></p>
<p>这种访问邻域然后选择最优的点进入，有些类似函数空间上的梯度下降，但并不准确，因此我称其为贪心搜索算法。</p>
<h1 id="4-Grid-Search和Greedy-Search的比较"><a href="#4-Grid-Search和Greedy-Search的比较" class="headerlink" title="4. Grid Search和Greedy Search的比较"></a>4. Grid Search和Greedy Search的比较</h1><h2 id="1-运行效率"><a href="#1-运行效率" class="headerlink" title="(1) 运行效率"></a>(1) 运行效率</h2><p>**Grid Search:  **</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Algorithm: Grid Search has been chosed.</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 8&#125;</span><br><span class="line">Average time cost: 318.987372s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 16&#125; </span><br><span class="line">Average time cost: 271.838465s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 254.311087s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 244.821887s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O0&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 241.217270s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 8&#125; </span><br><span class="line">Average time cost: 82.647090s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 16&#125; </span><br><span class="line">Average time cost: 59.657127s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 55.773572s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 50.092287s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 41.875394s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 8&#125; </span><br><span class="line">Average time cost: 80.311958s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 16&#125;</span><br><span class="line">Average time cost: 60.672041s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 58.227193s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 52.674716s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 44.953127s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 8&#125; </span><br><span class="line">Average time cost: 73.855066s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 16&#125; </span><br><span class="line">Average time cost: 54.200823s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 36.591904s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 27.134263s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 21.869392s</span><br><span class="line"></span><br><span class="line">Best combination:</span><br><span class="line">optimize_level: O3</span><br><span class="line">block_size: 128</span><br><span class="line">Average time cost: 21.869392</span><br><span class="line"></span><br><span class="line">Total time of the experiment: 10740.233052s</span><br></pre></td></tr></table></figure>

<p>**Greedy Search: **</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Algorithm: Greedy Search has been chosed.</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 57.523089s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O1&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 50.706293s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 64&#125; </span><br><span class="line">Average time cost: 27.557757s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 59.431044s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O2&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 48.006461s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 32&#125; </span><br><span class="line">Average time cost: 37.255367s</span><br><span class="line">Running parameters combination: &#123;optimize_level: O3&#125; &#123;block_size: 128&#125; </span><br><span class="line">Average time cost: 22.398077s</span><br><span class="line"></span><br><span class="line">Best combination:</span><br><span class="line">optimize_level: O3</span><br><span class="line">block_size: 128</span><br><span class="line">Average time cost: 22.398077</span><br><span class="line"></span><br><span class="line">Total time of the experiment: 1542.825604s</span><br></pre></td></tr></table></figure>

<p>差异显而易见。Greedy Search的搜索空间(7种组合)较Grid Search的搜索空间(20种组合)要小很多，整体运行时间也差异很大，Grid Search的搜索时间是Greedy Search的6倍多。并且Greedy Search也成功找到了正确的最优组合。</p>
<p>Greedy Search的运行效率一定程度上取决于初始点的选择。这次运气比较好，选择的初始点离最终点比较近。若初始点选为了{O0, 8}，可能耗时会大很多，但是必然低于Grid Search。</p>
<h2 id="2-结果准确性"><a href="#2-结果准确性" class="headerlink" title="(2) 结果准确性"></a>(2) 结果准确性</h2><p>虽然上面的结果显示Greedy Search找到了全局最优的参数组合，但是这并不是一种必然。上面提到过，Greedy Search的搜索方法类似于梯度下降法，因此很容易陷入局部最优点。因此Greedy Search提供的结果不一定是全局最优点。Grid Search的搜索结果如下： </p>
<p><img src="/2023/05/06/autotuner/image-20221025161604206.png" alt="image-20221025161604206"></p>
<p>显然，{O1, 128}就是一个局部最优点，因此若初始点变化一下，最终结果就有可能陷入局部最优点，从而给出一个错误的答案。</p>
<p>而比较起来，Grid Search给出的结果是一个全局最优的，而且是必然的。</p>
<h2 id="3-算法改进"><a href="#3-算法改进" class="headerlink" title="(3) 算法改进"></a>(3) 算法改进</h2><p>从两种算法的分析比较来看，Greedy Search可以做以下改进，一定程度上减小其进入局部最优点的概率。</p>
<ul>
<li>一开始随机选取的参数组合从1个变为多个，并且要尽可能覆盖整个参数空间。然后从这些参数组合中选择最优的参数组合，以其为起点进行Greedy Search。这样能减小陷入局部最小点的概率。</li>
<li>邻域可以从$n^2$个组合变为$n^3$，其中$n$为所有参数的种类数。在上面的参数组合的情况，即邻域从上,下,左,右的4个组合变为上,下,左,右,左上,右上,左下,右下8种组合，这样虽然每次的搜索范围变大了，但是可以更快地下降到局部最优点，并且搜索范围也更全面，不易错过全局最优点。</li>
</ul>
<h1 id="5-结果分析"><a href="#5-结果分析" class="headerlink" title="5. 结果分析"></a>5. 结果分析</h1><p>所有参数组合的结果如图所示：  </p>
<p><img src="/2023/05/06/autotuner/image-20221025161604206.png" alt="image-20221025161604206"></p>
<h2 id="1-Block-Size越大，程序运行效率越快"><a href="#1-Block-Size越大，程序运行效率越快" class="headerlink" title="(1) Block Size越大，程序运行效率越快"></a>(1) Block Size越大，程序运行效率越快</h2><p>对于每个优化等级，显然Block Size取得越大，程序运行的时间越短。改变Block Size实际上是在改变访问对缓存的读取模式。由于MatrixMultiply.c的数组大小是4096*4096的，显然不可能把所有数值都存进内存。因此数组元素的访问必然涉及磁盘的读写。而改变Block Size可以改变对缓存的读取模式。Block Size越大，缓存页的使用就越充分（前提是Block Size没有超过缓存页的大小），因此缓存使用越充分，程序运行的效率就越高。</p>
<h2 id="2-优化等级影响"><a href="#2-优化等级影响" class="headerlink" title="(2) 优化等级影响"></a>(2) 优化等级影响</h2><p>首先，O0优化等级和其他优化等级程序的差异是显著的，因此无论何种等级的优化，较之无优化程序都能提升一定效率（单就这个程序来说）。</p>
<ul>
<li>O1: 尝试减少代码大小，缩短代码执行时间，不会执行需要消耗大量编译时间的优化。对于大函数的编译优化会占用更多的时间和内存。</li>
<li>O2: 与-O1类似，会提升编译时间和代码性能，几乎开启除了时空权衡优化外的所有优化项</li>
<li>O3: 在-O2级别的基础上，开启了更多的优化项，最高优化等级，以编译时间、代码大小、内存为代价获取更高的性能。在部分情况下可能会降低性能。</li>
</ul>
<h3 id="O1"><a href="#O1" class="headerlink" title="O1"></a>O1</h3><p>通俗来说，O1优化可以省略一些必然性的计算，比如:  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> y = i+<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>会被优化为：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> y = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>对于矩阵乘法，一些必然性的加法乘法会被直接优化，减少运算量，因此大大增大了效率。</p>
<h3 id="O2"><a href="#O2" class="headerlink" title="O2"></a>O2</h3><p>而到了O2优化，可以明显发现，大部分Block Size使用了O2优化后，效率与O1优化相差无几，甚至还低于O1优化。我搜索了一下，发现O2优化打开了这个选项：  </p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-fforce-mem：在做算术操作前，强制将内存数据copy到寄存器中以后再执行。这会使所有的内存引用潜在的共同表达式，进而产出更高效的代码，当没有共同的子表达式时，指令合并将排出个别的寄存器载入。这种优化对于只涉及单一指令的变量, 这样也许不会有很大的优化效果. 但是对于在很多指令(必须数学操作)中都涉及到的变量来说, 这会时很显著的优化, 因为和访问内存中的值相比,处理器访问寄存器中的值要快的多。</span><br></pre></td></tr></table></figure>

<p>对于单变量涉及多计算时，这个优化效率很明显，但是对于频繁访问内存的矩阵乘法来说，该优化可能效果并不明显，甚至会让效率降低。</p>
<h3 id="O3"><a href="#O3" class="headerlink" title="O3"></a>O3</h3><p>O3优化的效率要显著优于前两种优化。尤其是在Block Size更大的时候。似乎Block Size越大，O3的效果越明显。我搜索到了相关的优化内容：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-fweb：构建用于保存变量的伪寄存器网络。 伪寄存器包含数据, 就像他们是寄存器一样, 但是可以使用各种其他优化技术进行优化, 比如cse和loop优化技术。这种优化会使得调试变得更加的不可能，因为变量不再存放于原本的寄存器中。 </span><br><span class="line"></span><br><span class="line">-frename-registers：在寄存器分配后，通过使用registers left over来避免预定代码中的虚假依赖。这会使调试变得非常困难，因为变量不再存放于原本的寄存器中了。 </span><br></pre></td></tr></table></figure>

<p>这两者针对的是变量的访问，对于矩阵乘法来说，要反复存取矩阵中的变量，因此该优化能显著提升效率。至于其优化效果随着Block Size的变大而增强，我猜测是伪寄存器访问缓存的效率越来越高。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/06/%E6%80%BB%E7%BB%93%E5%92%8C%E6%84%9F%E6%82%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xuchen Ma's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/06/%E6%80%BB%E7%BB%93%E5%92%8C%E6%84%9F%E6%82%9F/" class="post-title-link" itemprop="url">总结和感悟</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-05-06 10:22:14 / Modified: 11:15:03" itemprop="dateCreated datePublished" datetime="2023-05-06T10:22:14+08:00">2023-05-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-总结"><a href="#1-总结" class="headerlink" title="1 总结"></a>1 总结</h2><p>博客的搭建使用hexo，hexo是使用Node.js实现的，因此搭建过程中还复习了一下很久之前学过的Node.js的知识。另外博客的发布可以直接使用markdown，而我平时写报告之类的都是使用markdown，所以非常便利。</p>
<h2 id="2-踩坑"><a href="#2-踩坑" class="headerlink" title="2. 踩坑"></a>2. 踩坑</h2><p>主要踩了3个坑。</p>
<ul>
<li>typro零宽空格字符</li>
</ul>
<p>因为我本地markdown是使用typro编辑的，他对于不同的段落自动起始字符会生成一个零宽空格字符，要命的是在typro、vscode，甚至记事本上都看不到这个零宽空格字符(不愧是“零宽”)，最后是用的IDEA编辑器才看到这个零宽空格字符ZWSP，将其删掉，hexo才能正常生成博客。</p>
<ul>
<li>博客插入图片问题</li>
</ul>
<p>博客插入图片问题也困扰了我很久。因为typro原本默认是使用<code>文件名.assets</code>文件夹作为图片文件夹的，但是hexo读取安装插件之后默认读取markdown的同名文件夹作为资源文件夹，这个bug调了好久。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
